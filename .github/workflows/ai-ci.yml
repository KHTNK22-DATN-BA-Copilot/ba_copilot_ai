name: AI CI

on:
  push:
    branches: 
      - main
  pull_request:
    branches:
      - main

  jobs:
    # ========== CI: Build ==========
    build:
      runs-on: ["self-hosted", "Linux", "X64"]
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Setup Python
          uses: actions/setup-python@v4
          with:
            python-version: 3.11
            cache: 'pip'

        - name: Install dependencies
          run: pip install -r requirements.txt

        - name: Syntax check
          run: ruff check .

    # ========== CI: Test ==========
    # test:
    #   runs-on: ["self-hosted", "Linux", "X64"]
    #   needs: build
    #   steps:
    #     - name: Checkout code
    #       uses: actions/checkout@v4

    #     - name: Setup Python
    #       uses: actions/setup-python@v4
    #       with:
    #         python-version: 3.11
    #         cache: 'pip'

    #     - name: Install dependencies
    #       run: pip install -r requirements.txt

    #     - name: Run tests
    #       run: pytest tests/

    # ========== CD: Deploy to VPS ==========
    deploy:
      runs-on: ["self-hosted", "Linux", "X64"]
      needs: test
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Pull latest code to VPS
          run: |
            cd /home/bacopilot/bacopilot/ba_copilot_ai  
            git pull origin main

        - name: Stop ai container
          run: docker compose stop ai || true
          working-directory: /home/bacopilot/bacopilot

        - name: Remove ai container
          run: docker compose rm -f ai || true
          working-directory: /home/bacopilot/bacopilot

        - name: Build ai image
          run: docker compose build --no-cache ai
          working-directory: /home/bacopilot/bacopilot

        - name: Start ai container
          run: docker compose up -d ai
          working-directory: /home/bacopilot/bacopilot

        - name: Cleanup old Docker images
          run: docker image prune -f

        - name: Health check
          run: |
            echo "Waiting for ai container to start..."
            sleep 10
            docker ps | grep ba-copilot-ai || echo "Warning: AI container may not be running"